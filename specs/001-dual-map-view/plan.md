# Implementation Plan: Dual Map View

**Branch**: `001-dual-map-view` | **Date**: 2026-02-28 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/001-dual-map-view/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command following the workflow in `.specify/templates/plan-template.md`.

## Summary

Build a responsive web application that displays two interactive world maps side by side, each independently navigable. Users can pan and zoom each map to compare different geographic locations. The application uses Vue 3 for the frontend framework, Leaflet for map rendering, and OpenStreetMap for tile data. The implementation emphasizes component modularity, type safety, accessibility, and performance per the project constitution.

**Primary Requirement**: Enable visual comparison of geographic locations through dual independent map views.

**Technical Approach** (from research.md):
- Direct Leaflet API integration with Vue 3 Composition API (no wrapper libraries)
- Composable-first architecture for reusable map logic
- TypeScript strict mode with explicit types for map coordinates and state
- ShallowRef pattern to prevent Vue reactivity issues with Leaflet objects
- Event adapter pattern for translating Leaflet events to Vue component events

## Technical Context

**Language/Version**: TypeScript 5.x with strict mode enabled  
**Runtime**: Node.js 20 LTS  
**Frontend Framework**: Vue 3.4+ (Composition API)  
**Primary Dependencies**:
  - leaflet (^1.9.4) - Map rendering library
  - @types/leaflet (^1.9.8) - TypeScript definitions for Leaflet
  - vite (^5.0.0) - Build tool and dev server
  
**Storage**: N/A (stateless application, no persistence in MVP)  
**Testing**: Vitest for unit/component tests, Playwright for E2E tests (optional for MVP)  
**Target Platform**: Modern browsers (Chrome 90+, Firefox 88+, Safari 14+, Edge 90+)  
**Project Type**: Single-page web application (SPA)  
**Performance Goals**:
  - Initial map load: <3 seconds on 25 Mbps connection
  - Pan/zoom interactions: <100ms perceived delay
  - First Contentful Paint: <1.5 seconds
  
**Constraints**:
  - No external state management library (use Vue reactivity)
  - Must work offline for already-cached tiles (service worker not required for MVP)
  - Maximum bundle size: <500KB (gzipped, excluding map tiles)
  
**Scale/Scope**:
  - Single feature application (dual map view only)
  - No user accounts or backend services
  - No persistent state across sessions in MVP
  - Target: Personal/small team usage (no scalability requirements)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Pre-Research Check (✅ PASSED)

| Principle | Requirement | Compliance | Notes |
|-----------|-------------|------------|-------|
| I. User-First Design | Features serve primary use case | ✅ PASS | Dual map comparison is entire purpose; all features directly support this |
| I. User-First Design | Intuitive UI, minimal clicks | ✅ PASS | Direct manipulation (drag/zoom), no complex workflows |
| I. User-First Design | Immediate visual feedback | ✅ PASS | Real-time pan/zoom, no loading delays between interactions |
| II. Component Architecture | Modular, reusable components | ✅ PASS | MapPanel reused twice, composables extract shared logic |
| II. Component Architecture | Single responsibility | ✅ PASS | MapPanel=single map, MapContainer=layout only |
| II. Component Architecture | Props/params, not global state | ✅ PASS | All configuration via props, no global singletons |
| III. Type Safety | TypeScript strict mode | ✅ PASS | tsconfig.json configured with strict:true |
| III. Type Safety | Explicit types | ✅ PASS | All function signatures typed, see types/map.types.ts |
| III. Type Safety | Branded types for coordinates | ✅ PASS | Coordinate interface prevents unit confusion |
| IV. Responsive & Accessible | Cross-device support | ✅ PASS | Breakpoint-based layout (768px), touch gesture support |
| IV. Responsive & Accessible | Keyboard navigable | ✅ PASS | Tab focus, arrow keys, +/- zoom (User Story 3) |
| IV. Responsive & Accessible | Screen reader support | ✅ PASS | ARIA labels, role attributes, live announcements |
| V. Performance | Initial load <3s | ✅ PASS | Measured goal in spec (SC-001) |
| V. Performance | Interactions <100ms | ✅ PASS | Measured goal in spec (SC-004), debouncing strategy in research.md |
| V. Performance | Lazy load, cache | ✅ PASS | Leaflet handles tile lazy loading, browser caches tiles |
| VI. Testing Flexibility | Tests encouraged, not mandated | ✅ PASS | Spec marks tests as optional, no TDD requirement |
| VII. Simplicity | YAGNI principle | ✅ PASS | No speculative features (see spec.md "Out of Scope" section) |
| VII. Simplicity | Justify dependencies | ✅ PASS | Only 2 runtime deps (Leaflet, Vue); both essential for core functionality |

**Gate Decision**: ✅ PROCEED to Phase 0 Research

**Justification**: All 7 constitution principles satisfied. No violations requiring complexity tracking.

### Post-Design Check (✅ PASSED)

Re-evaluated after Phase 1 design artifacts (data-model.md, contracts/, quickstart.md):

| Principle | Design Compliance | Evidence |
|-----------|-------------------|----------|
| I. User-First Design | Clear user value | Each component contract maps to user scenario (US1: Display, US2: Navigate) |
| II. Component Architecture | Reusable components | MapPanel component contract shows reusability; used twice in MapContainer |
| III. Type Safety | Explicit types | data-model.md entities all have typed attributes; contracts specify prop types |
| IV. Responsive & Accessible | Accessibility built-in | MapPanel.contract.md includes ARIA section, keyboard navigation table |
| V. Performance | Optimized design | research.md specifies terminal events (moveend/zoomend) not intermediate events |
| VI. Testing Flexibility | Not over-tested | Quickstart guide includes tests as "next steps" not blockers |
| VII. Simplicity | Minimal design | 2 components (MapPanel, MapContainer), 1 core composable (useLeafletMap) |

**Gate Decision**: ✅ PROCEED to Phase 2 Implementation Planning

**No violations introduced during design phase.**

## Project Structure

### Documentation (this feature)

```text
specs/001-dual-map-view/
├── plan.md              # This file (/speckit.plan command output)
├── spec.md              # Feature specification
├── research.md          # Phase 0 research findings (Leaflet + Vue best practices)
├── data-model.md        # Phase 1 entities and state management
├── quickstart.md        # Phase 1 quickstart implementation guide
├── contracts/           # Phase 1 component interface specifications
│   ├── README.md        # Contract philosophy and versioning
│   ├── MapPanel.contract.md       # MapPanel public API
│   └── MapContainer.contract.md   # MapContainer public API
├── checklists/          # Quality validation checklists
│   └── requirements.md  # Spec completeness checklist
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT YET CREATED)
```

### Source Code (repository root)

This is a single-page web application (no backend). The structure follows Vue 3 + Vite conventions.

```text
distance-comparer/
├── public/              # Static assets
│   └── favicon.ico
├── src/
│   ├── components/      # Vue components
│   │   ├── MapPanel.vue           # Single map instance component
│   │   ├── MapContainer.vue       # Layout wrapper for dual maps
│   │   └── MapErrorBoundary.vue   # Error handling wrapper (optional)
│   ├── composables/     # Composition API logic
│   │   ├── useLeafletMap.ts       # Core map initialization/cleanup
│   │   ├── useMapNavigation.ts    # Pan/zoom state management
│   │   ├── useMapEvents.ts        # Event adapter (Leaflet → Vue)
│   │   └── useMapKeyboard.ts      # Keyboard navigation logic
│   ├── types/           # TypeScript type definitions
│   │   └── map.types.ts           # Shared map interfaces
│   ├── config/          # Configuration constants
│   │   └── map.config.ts          # Default map settings (tile URLs, zoom levels)
│   ├── App.vue          # Root application component
│   ├── main.ts          # Application entry point
│   └── assets/          # CSS and other assets
│       └── main.css
├── tests/               # Test files (optional for MVP)
│   ├── unit/            # Unit tests for composables
│   ├── component/       # Component tests
│   └── e2e/             # End-to-end tests (Playwright)
├── index.html           # HTML entry point
├── vite.config.ts       # Vite configuration
├── tsconfig.json        # TypeScript configuration
├── package.json         # Dependencies and scripts
└── README.md            # Project documentation
```

**Structure Decision**: **Option 1: Single Project (Web Application)**

Selected because:
- This is a frontend-only application with no backend services
- No API layer needed (OpenStreetMap tiles loaded directly from CDN)
- Monolithic SPA simplifies development and deployment
- No need for frontend/backend separation (Option 2) or mobile platforms (Option 3)

**Key Directories**:
- `src/components/`: Vue Single-File Components (SFCs) with scoped styles
- `src/composables/`: Reusable Composition API logic (business logic extraction per Principle II)
- `src/types/`: Centralized TypeScript definitions (strict mode per Principle III)
- `src/config/`: Configuration constants (tile URLs, default coordinates, zoom levels)

**Conventions**:
- Component names: PascalCase (MapPanel.vue)
- Composable names: camelCase with `use` prefix (useLeafletMap.ts)
- Type files: camelCase with `.types.ts` suffix (map.types.ts)
- Test files: Co-located with source or in parallel `tests/` directory

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

N/A - No constitution violations detected. All principles satisfied without exceptions.

## Phase Outputs Summary

### Phase 0: Research (✅ COMPLETED)

**Artifact**: [research.md](research.md)

**Key Decisions Made**:
1. **Integration Pattern**: Direct Leaflet API with Composition API (no vue3-leaflet wrapper)
2. **Reactivity Strategy**: Use `shallowRef` for Leaflet instances to prevent proxy wrapping
3. **Architecture**: Composable-first with event adapter pattern
4. **Performance**: Terminal events (moveend/zoomend) with debouncing, not continuous events
5. **TypeScript**: @types/leaflet with custom type guards, avoid reactive proxies on Leaflet objects
6. **Tile Provider**: OpenStreetMap primary, compliant attribution, client-side throttling

**Research Areas Covered**:
- Vue + Leaflet integration patterns (lifecycle management, reactivity boundaries)
- Component architecture (composables vs wrappers, prop drilling vs provide/inject)
- Event handling (Leaflet imperative API → Vue declarative events)
- Performance optimization (debouncing, lazy loading, memory management)
- TypeScript integration (type safety for map coordinates and state)
- OpenStreetMap configuration (tile URLs, attribution, rate limiting)

### Phase 1: Design Artifacts (✅ COMPLETED)

**Artifacts**:
1. [data-model.md](data-model.md) - Entity definitions and state management
2. [contracts/](contracts/) - Component interface specifications
3. [quickstart.md](quickstart.md) - Step-by-step implementation guide

**Data Model Entities**:
- **MapPanel**: Single map instance (center, zoom, viewport, focus state, loading state)
- **MapContainer**: Layout manager for two panels (layout mode, breakpoint, panel references)
- **TileLayer**: Tile source configuration (URL template, attribution, zoom limits)
- **MapInteraction**: User interaction state during navigation (dragging, zooming, input mode)
- **KeyboardNavigationState**: Keyboard control state (focused panel, step sizes, key mappings)

**Component Contracts**:
- **MapPanel**: 9 props, 8 events, 3 slots, 9 exposed methods; full accessibility spec
- **MapContainer**: 5 props, 2 events, 4 slots, 5 exposed methods; responsive layout logic

**Quickstart Guide**:
- 7-step implementation workflow (4-6 hour estimate)
- Code examples for all major components
- Testing checklist and common issues troubleshooting

### Phase 2: Task Planning (⏳ PENDING)

**Next Command**: `/speckit.tasks`

This will generate `tasks.md` with:
- Granular implementation tasks organized by user story
- Test case definitions (optional per Principle VI)
- Task dependencies and parallel execution opportunities
- Estimated effort per task

**Not part of this command's scope** - refer to mode instructions which state:
> "Command ends after Phase 2 planning. Report branch, IMPL_PLAN path, and generated artifacts."

Phase 2 (tasks) is generated by a separate command.

## Implementation Readiness

**Status**: ✅ READY FOR IMPLEMENTATION

All planning prerequisites complete:
- ✅ Constitution compliance verified (no violations)
- ✅ Technical decisions researched and documented
- ✅ Data model defined with validation rules
- ✅ Component contracts specified with versioning
- ✅ Quickstart guide provides working prototype path
- ✅ Project structure defined and justified

**Next Steps**:
1. Run `/speckit.tasks` to generate task breakdown
2. Follow quickstart.md to build working prototype (4-6 hours)
3. Implement remaining tasks from tasks.md (organized by user story priority)
4. Reference research.md for implementation details and anti-patterns to avoid

**Dependencies**:
- Node.js 20 LTS installed
- Git repository initialized (already done)
- Branch `001-dual-map-view` checked out (already done)

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Leaflet reactivity bugs | Medium | High | Follow research.md shallowRef pattern; extensively documented |
| Performance degradation with large tile counts | Low | Medium | Leaflet handles this; debounce events per research.md |
| Mobile touch gesture conflicts | Low | Medium | Test early on mobile devices; Leaflet has good touch support |
| OpenStreetMap rate limiting | Low | Low | Client-side throttling; tiles cached by browser |
| Keyboard navigation complexity | Medium | Low | Well-specified in contracts; incremental implementation (US3 is P3) |
| TypeScript strict mode friction | Low | Low | Types defined upfront in data-model.md and contracts |

**Overall Risk Level**: **LOW**

All medium risks have documented mitigations in research.md.

## Success Criteria Mapping

| Success Criterion (from spec.md) | Design Evidence | Implementation Guide |
|----------------------------------|-----------------|---------------------|
| SC-001: Load within 3s | research.md: lazy tile loading, browser caching | quickstart.md: Vite optimization, Leaflet defaults |
| SC-002: Independent panning | data-model.md: Each MapPanel owns state | contracts: No state sharing between panels |
| SC-003: Independent zooming | Same as SC-002 | Same as SC-002 |
| SC-004: Interactions <100ms | research.md: Terminal events, debouncing | quickstart.md: Event adapter pattern |
| SC-005: Cross-browser/device | contracts: Responsive layout, touch support | quickstart.md: Step 5 responsive CSS |
| SC-006: Keyboard accessible | contracts: Full ARIA spec, keyboard table | quickstart.md: Focus handling, tabindex |
| SC-007: Error resilience | data-model.md: Error states, recovery | contracts: Error events, retry slots |

All success criteria have concrete design backing and implementation guidance.

## References

- **Feature Specification**: [spec.md](spec.md)
- **Research Findings**: [research.md](research.md)
- **Data Model**: [data-model.md](data-model.md)
- **Component Contracts**: [contracts/](contracts/)
- **Quickstart Guide**: [quickstart.md](quickstart.md)
- **Constitution**: [.specify/memory/constitution.md](../../.specify/memory/constitution.md)

---

**Plan Version**: 1.0.0  
**Generated**: 2026-02-28  
**Command**: `/speckit.plan` with inputs: Leaflet, OpenStreetMap, Vue 3

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| [e.g., 4th project] | [current need] | [why 3 projects insufficient] |
| [e.g., Repository pattern] | [specific problem] | [why direct DB access insufficient] |
