# Implementation Plan: Distance Line Tool

**Branch**: `002-distance-line-tool` | **Date**: February 28, 2026 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/002-distance-line-tool/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command following the workflow in `.specify/templates/plan-template.md`.

## Summary

Add a distance measurement tool that allows users to draw a straight line on the left map with draggable endpoints anchored to geographic coordinates. A corresponding line of identical real-world length appears on the right map, independently positionable and rotatable while maintaining length synchronization. The implementation extends the existing Vue 3 + Leaflet dual-map architecture with new composables for geodesic calculations, line management, and drag interactions.

**Primary Requirement**: Enable distance comparison across different locations by synchronizing line lengths between independent map views.

**Technical Approach** (from research.md):
- Leaflet Polyline with custom drag handles for endpoints
- Geodesic distance calculation using Haversine formula or turf.js
- Reactive state management via composables (useDistanceLine, useLineDrag)
- Event synchronization between maps for length updates
- Transform calculations for right map line rotation while preserving length

## Technical Context

**Language/Version**: TypeScript 5.x with strict mode enabled  
**Runtime**: Node.js 20 LTS  
**Frontend Framework**: Vue 3.4+ (Composition API)  
**Primary Dependencies**:
  - leaflet (^1.9.4) - Map rendering and polyline drawing
  - @types/leaflet (^1.9.8) - TypeScript definitions
  - @turf/turf (^7.0.0) - Geodesic distance calculations (or manual Haversine)
  - vite (^5.0.0) - Build tool
  
**Storage**: N/A (stateless application, no persistence)  
**Testing**: Vitest for unit/component tests, Playwright for E2E tests (optional)  
**Target Platform**: Modern browsers (Chrome 90+, Firefox 88+, Safari 14+, Edge 90+)  
**Project Type**: Single-page web application (SPA) - extension of existing dual-map feature  
**Performance Goals**: See [spec.md Performance Requirements section](spec.md#performance-requirements-mandatory) for detailed targets:
  - Line creation: <100ms
  - Endpoint drag: <16ms (60fps)
  - Distance calculation: <10ms
  - Left-right synchronization: <100ms
  
**Constraints**:
  - Must integrate with existing MapPanel component without breaking changes
  - Single distance line at a time (adding new line replaces existing)
  - Real-time visual feedback during all interactions (no loading states)
  - Geodesic accuracy: Â±0.5% error for distances up to 20,000km  - Touch support: Mobile/tablet support via Leaflet's built-in touch handlers (no separate touch implementation required)  
**Scale/Scope**:
  - Single feature addition to existing dual-map application
  - No backend services required
  - Extends existing composable architecture
  - Adds 3-4 new composables, 1-2 new components for line rendering

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Pre-Research Check (âœ… PASSED)

| Principle | Requirement | Compliance | Notes |
|-----------|-------------|------------|-------|
| I. User-First Design | Features serve primary use case | âœ… PASS | Distance comparison is core value proposition; line tool directly enables this |
| I. User-First Design | Intuitive UI, minimal clicks | âœ… PASS | 2 clicks to create line, direct drag for modifications |
| I. User-First Design | Immediate visual feedback | âœ… PASS | Real-time updates during drag, instant right map synchronization (FR-013, SC-004) |
| I. User-First Design | Clear error communication | âœ… PASS | Edge cases identified in spec (zero-length, viewport bounds) |
| II. Component Architecture | Modular, reusable components | âœ… PASS | Composables for line logic, reuses existing MapPanel |
| II. Component Architecture | Single responsibility | âœ… PASS | Separate composables: useDistanceLine (state), useLineDrag (interaction), useGeodesic (calc) |
| II. Component Architecture | Props/params, not global state | âœ… PASS | Line state managed per-map via composables, no global singletons |
| III. Type Safety | TypeScript strict mode | âœ… PASS | Existing tsconfig.json with strict:true |
| III. Type Safety | Explicit types | âœ… PASS | Will define LineEndpoint, DistanceLine, LineOrientation types |
| III. Type Safety | Branded types for coordinates | âœ… PASS | Reuses existing Coordinate type from map.types.ts |
| IV. Responsive & Accessible | Cross-device support | âœ… PASS | Touch drag support for mobile, existing responsive layout maintained |
| IV. Responsive & Accessible | Keyboard navigable | âœ… PASS | Will add keyboard shortcuts for line placement/modification |
| IV. Responsive & Accessible | Screen reader support | âœ… PASS | Will announce distance values and line state changes |
| V. Performance | Initial load <3s | âœ… PASS | No new bundle weight beyond small composables (<10KB) |
| V. Performance | Interactions <100ms | âœ… PASS | SC-004: drag updates <100ms; SC-006: synchronization <100ms |
| V. Performance | Lazy load, cache | âœ… PASS | Line rendering via Leaflet (already optimized), calculations cached |
| V. Performance | Non-blocking computations | âœ… PASS | Geodesic calculations <10ms, won't block main thread |
| VI. Testing Flexibility | Tests encouraged, not mandated | âœ… PASS | Unit tests for geodesic calculations recommended; UI tests optional |
| VII. Simplicity | YAGNI principle | âœ… PASS | Single line only (FR-011), no multi-line or persistence |
| VII. Simplicity | Justify dependencies | ðŸŸ¡ REVIEW | New dependency: @turf/turf for geodesic calculations |

**Dependency Justification**: @turf/turf (or manual Haversine implementation)
- **Why needed**: Accurate geodesic distance calculation accounting for Earth's curvature (FR-004)
- **Alternatives considered**:
  1. Manual Haversine formula implementation (~30 lines) - preferred if accuracy sufficient
  2. @turf/distance (subset) - ~15KB for distance calculation only
  3. Full @turf/turf - ~100KB comprehensive geospatial library
- **Decision**: Start with manual Haversine (sufficient for <5% error). Only add @turf if higher accuracy needed.

**Gate Decision**: âœ… PROCEED to Phase 0 Research

**Minor Concern**: Dependency choice requires research in Phase 0. If manual Haversine insufficient, must justify @turf addition against Principle VII.

### Post-Design Check (âœ… PASSED)

Re-evaluated after Phase 1 design artifacts (data-model.md, contracts/, quickstart.md):

| Principle | Design Compliance | Evidence |
|-----------|-------------------|----------|
| I. User-First Design | Clear user value | Two-click creation (US1), drag endpoints (US2), rotation (US4) all user-driven |
| I. User-First Design | Minimal clicks | 2 clicks to create (spec SC-001), direct drag for adjustments |
| I. User-First Design | Immediate feedback | Debounced to 16ms (60fps), RAF scheduling in research.md |
| II. Component Architecture | Reusable components | DistanceLine reused for both maps; composables extracted (useGeodesic, useDistanceLine) |
| II. Component Architecture | Single responsibility | Each composable has one job: geodesic calc, line state, drag handling, sync |
| II. Component Architecture | No global state | All state via composables, props passed to components (contract specifies) |
| III. Type Safety | Explicit types | data-model.md defines all entities with typed attributes; contract specifies prop types |
| III. Type Safety | Coordinate types | Reuses existing Coordinate type from spec 001 (map.types.ts) |
| IV. Responsive & Accessible | Accessibility | Contract includes full ARIA spec, keyboard navigation table, screen reader announcements |
| IV. Responsive & Accessible | Cross-device | Touch drag support noted in research.md; responsive layout maintained |
| V. Performance | Optimized design | Research.md specifies debouncing (16ms), RAF scheduling, distance caching |
| V. Performance | Performance targets | All targets measurable: <100ms sync, <16ms drag, <10ms calculation |
| VI. Testing Flexibility | Pragmatic testing | Quickstart marks unit tests "recommended", component tests "optional" |
| VII. Simplicity | Minimal dependencies | Research.md chose manual Haversine (0 KB) over @turf (~100 KB) |
| VII. Simplicity | No over-engineering | Single line only (FR-011), no multi-line arrays, no persistence, no backend |

**Gate Decision**: âœ… PROCEED to Implementation

**No violations introduced during design phase.** Manual Haversine implementation selected per Principle VII, avoiding unnecessary dependencies.

## Project Structure

### Documentation (this feature)

```text
specs/002-distance-line-tool/
â”œâ”€â”€ plan.md              # This file (/speckit.plan command output)
â”œâ”€â”€ spec.md              # Feature specification
â”œâ”€â”€ research.md          # Phase 0 research findings (geodesic calculations, Leaflet polylines)
â”œâ”€â”€ data-model.md        # Phase 1 entities (DistanceLine, LineEndpoint, etc.)
â”œâ”€â”€ quickstart.md        # Phase 1 quickstart implementation guide
â”œâ”€â”€ contracts/           # Phase 1 component interface specifications
â”‚   â”œâ”€â”€ README.md        # Contract philosophy
â”‚   â””â”€â”€ DistanceLine.contract.md  # Distance line component API
â”œâ”€â”€ checklists/          # Quality validation checklists
â”‚   â””â”€â”€ requirements.md  # Spec completeness checklist (already completed)
â””â”€â”€ tasks.md             # Phase 2 output (/speckit.tasks command - NOT YET CREATED)
```

### Source Code (repository root)

This feature extends the existing single-page web application structure. New files in **bold**.

```text
distance-comparer/
â”œâ”€â”€ public/              # Static assets
â”‚   â””â”€â”€ robots.txt
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/      # Vue components
â”‚   â”‚   â”œâ”€â”€ MapPanel.vue           # Single map instance (EXISTING - will extend)
â”‚   â”‚   â”œâ”€â”€ MapContainer.vue       # Layout wrapper (EXISTING - unchanged)
â”‚   â”‚   â””â”€â”€ **DistanceLine.vue**   # Distance line overlay component (NEW - renders line and endpoints)
â”‚   â”œâ”€â”€ composables/     # Composition API logic
â”‚   â”‚   â”œâ”€â”€ useLeafletMap.ts       # Core map init (EXISTING - unchanged)
â”‚   â”‚   â”œâ”€â”€ useMapNavigation.ts    # Pan/zoom state (EXISTING - unchanged)
â”‚   â”‚   â”œâ”€â”€ useMapEvents.ts        # Event adapter (EXISTING - may extend)
â”‚   â”‚   â”œâ”€â”€ useMapKeyboard.ts      # Keyboard nav (EXISTING - may extend)
â”‚   â”‚   â”œâ”€â”€ **useDistanceLine.ts** # Distance line state management (NEW)
â”‚   â”‚   â”œâ”€â”€ **useLineDrag.ts**     # Drag interaction for endpoints (NEW)
â”‚   â”‚   â”œâ”€â”€ **useGeodesic.ts**     # Geodesic distance calculations (NEW)
â”‚   â”‚   â””â”€â”€ **useLineSync.ts**     # Left-right map line synchronization (NEW)
â”‚   â”œâ”€â”€ types/           # TypeScript type definitions
â”‚   â”‚   â””â”€â”€ map.types.ts           # Shared map interfaces (EXTEND with line types)
â”‚   â”œâ”€â”€ config/          # Configuration constants
â”‚   â”‚   â””â”€â”€ map.config.ts          # Map settings (EXTEND with line styling)
â”‚   â”œâ”€â”€ App.vue          # Root application component (EXISTING - unchanged)
â”‚   â”œâ”€â”€ main.ts          # Entry point (EXISTING - unchanged)
â”‚   â””â”€â”€ assets/          # CSS and other assets
â”‚       â””â”€â”€ main.css     # Styles (EXTEND with line styles)
â”œâ”€â”€ tests/               # Test files (optional)
â”‚   â”œâ”€â”€ unit/
â”‚   â”‚   â””â”€â”€ **useGeodesic.spec.ts** # Unit tests for distance calculations (RECOMMENDED)
â”‚   â”œâ”€â”€ component/
â”‚   â”‚   â””â”€â”€ **DistanceLine.spec.ts** # Component tests (OPTIONAL)
â”‚   â””â”€â”€ e2e/             # End-to-end tests (OPTIONAL)
â”œâ”€â”€ index.html           # HTML entry point
â”œâ”€â”€ vite.config.ts       # Vite configuration
â”œâ”€â”€ tsconfig.json        # TypeScript configuration
â”œâ”€â”€ package.json         # Dependencies (MAY ADD @turf/distance)
â””â”€â”€ README.md            # Project documentation
```

**Structure Decision**: **Extends existing single-project web application structure**

This feature builds on the existing dual-map view (spec 001) without requiring structural changes. All new code follows established conventions:
- New components in `src/components/` (DistanceLine.vue, LineEndpointMarker.vue)
- New composables in `src/composables/` (4 new: useDistanceLine, useLineDrag, useGeodesic, useLineSync)
- Types added to existing `src/types/map.types.ts` file
- Reuses existing MapPanel component without breaking changes
- No backend, no new directories required

**Key Files to Modify**:
- `src/types/map.types.ts`: Add DistanceLine, LineEndpoint, LineOrientation interfaces
- `src/config/map.config.ts`: Add line styling constants (color, width, opacity)
- `src/components/MapPanel.vue`: Integrate DistanceLine component as optional overlay

**Key Files to Create**:
- 4 new composables for line management
- 1 new component (DistanceLine.vue) for line rendering and interaction
- 1 contract document for component API

## Complexity Tracking

N/A - No constitution violations detected. The minor dependency concern (@turf/turf) will be resolved in Phase 0 research by preferring manual Haversine implementation.

## Phase Outputs Summary

### Phase 0: Research (âœ… COMPLETED)

**Artifact**: [research.md](research.md)

**Key Decisions Made**:
1. **Distance Calculation**: Manual Haversine formula (0 KB) instead of @turf (~100 KB)
2. **Leaflet Integration**: Polyline + CircleMarker with L.Draggable for endpoints
3. **Synchronization**: Reactive composable with Vue watch + Leaflet event bridge
4. **Rotation**: Bearing-based destination point calculation (geodesically correct)
5. **Performance**: Debounced updates (16ms), RAF scheduling, distance caching

**Research Areas Covered**:
- Geodesic distance calculation methods (Haversine vs Vincenty vs @turf)
- Leaflet Polyline with draggable endpoints (native vs plugins)
- Line synchronization patterns (Vue reactivity + Leaflet events)
- Right map line rotation (bearing calculations, destination points)
- Performance optimization (debouncing, RAF, caching strategies)

### Phase 1: Design Artifacts (âœ… COMPLETED)

**Artifacts**:
1. [data-model.md](data-model.md) - Entity definitions and state management
2. [contracts/](contracts/) - Component interface specifications
3. [quickstart.md](quickstart.md) - Step-by-step implementation guide

**Data Model Entities**:
- **DistanceLine**: Line state (start, end, distance, bearing, visibility)
- **LineEndpoint**: Draggable anchor point (position, drag state, styling)
- **LineOrientation**: Rotation state for right map (bearing, rotation anchor)
- **LineSynchronization**: Left-right coordination (distance sync, latency tracking)
- **LineCreationState**: Two-click workflow (mode, first click, preview line)
- **DistanceUnit**: Display formatting (meters, km, miles, feet)

**Component Contracts**:
- **DistanceLine**: 7 props, 6 events, 2 slots, 6 exposed methods; full accessibility spec

**Quickstart Guide**:
- 8-phase implementation workflow (6-8 hour estimate)
- Code examples for all composables and components
- Testing checklist and troubleshooting guide
- Builds on existing spec 001 infrastructure

### Phase 2: Task Planning (â³ PENDING)

**Next Command**: /speckit.tasks

This will generate 	asks.md with:
- Granular implementation tasks organized by user story
- Test case definitions (optional per Principle VI)
- Task dependencies and parallel execution opportunities
- Estimated effort per task

**Not part of this command's scope** - refer to mode instructions which state:
> "Command ends after Phase 2 planning."

Phase 2 (tasks) is generated by a separate command.

## Implementation Readiness

**Status**: âœ… READY FOR IMPLEMENTATION

All planning prerequisites complete:
- âœ… Constitution compliance verified (no violations, manual Haversine selected)
- âœ… Technical decisions researched and documented
- âœ… Data model defined with validation rules and state transitions
- âœ… Component contracts specified with full API documentation
- âœ… Quickstart guide provides working prototype path (6-8 hours)
- âœ… Project structure defined and extends spec 001
- âœ… Agent context updated with new technologies

**Next Steps**:
1. Run /speckit.tasks to generate task breakdown
2. Follow quickstart.md phases sequentially to build working prototype
3. Implement remaining features from tasks.md (organized by user story priority)
4. Reference research.md for implementation details and anti-patterns

**Dependencies**:
- Spec 001 (Dual Map View) fully implemented
- Node.js 20 LTS installed
- Git repository initialized
- Branch  02-distance-line-tool checked out âœ…

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Haversine accuracy insufficient | Low | Medium | Research.md validates Â±0.5% accuracy sufficient; can upgrade to Vincenty if needed |
| Drag performance issues on mobile | Medium | Medium | Debouncing + RAF scheduling documented; test early on devices |
| Left-right sync latency >100ms | Low | Medium | Lightweight calculations (<10ms), Vue watch overhead minimal |
| Endpoint drag conflicts with map pan | Medium | Low | Leaflet.Draggable propagation control; well-documented pattern |
| Rotation UI/UX unclear | Medium | Low | Research.md specifies keyboard + mouse patterns; iterate based on user feedback |
| Integration breaks existing MapPanel | Low | High | Non-breaking extension via slots; contract specifies backward compatibility |
| Zero-length line edge case | Low | Low | data-model.md documents behavior; disable rotation, show tooltip |
| TypeScript strict mode friction | Low | Low | All types defined upfront in data-model.md and contracts |

**Overall Risk Level**: **LOW**

All medium risks have documented mitigations in research.md. Integration risk minimal due to slot-based extension pattern.

## Success Criteria Mapping

| Success Criterion (from spec.md) | Design Evidence | Implementation Guide |
|----------------------------------|-----------------|---------------------|
| SC-001: Create line in 2 clicks | data-model.md: LineCreationState workflow | quickstart.md Phase 4: Two-click creation |
| SC-002: Endpoints anchored across zoom levels | research.md: Leaflet lat/lng anchoring | quickstart.md: CircleMarker with fixed coords |
| SC-003: 99.5% distance accuracy | research.md: Ha versine Â±0.5% validated | quickstart.md Phase 2: useGeodesic implementation |
| SC-004: Drag updates <100ms | research.md: Debounce 16ms + RAF | quickstart.md Phase 2: Performance optimization |
| SC-005: Rotate smoothly (30fps) | research.md: RAF scheduling for rotation | quickstart.md Phase 8: Rotation implementation |
| SC-006: Sync <100ms | research.md: Lightweight Vue watch | quickstart.md Phase 7: Synchronization |
| SC-007: Complete task in 30 sec | Quickstart: 2 clicks + drag workflow | Entire quickstart guide design |
| SC-008: Visible at all locations | Leaflet global tile support | Inherits from spec 001 implementation |

All success criteria have concrete design backing and implementation guidance.

## References

- **Feature Specification**: [spec.md](spec.md)
- **Research Findings**: [research.md](research.md)
- **Data Model**: [data-model.md](data-model.md)
- **Component Contracts**: [contracts/](contracts/)
- **Quickstart Guide**: [quickstart.md](quickstart.md)
- **Constitution**: [../../.specify/memory/constitution.md](../../.specify/memory/constitution.md)
- **Spec 001 (Dual Map View)**: [../001-dual-map-view/plan.md](../001-dual-map-view/plan.md)

---

**Plan Version**: 1.0.0  
**Generated**: February 28, 2026  
**Command**: /speckit.plan  
**Extends**: Spec 001 (Dual Map View)
